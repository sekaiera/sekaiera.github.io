<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–∞–ø—ë—Ä ‚Äî —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      --panel-bg: rgba(255,255,255,0.05);
      --accent: #00c896;
      --accent2: #00a3ff;
      --danger: #ff4f4f;
      --success: #4fff93;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    #topBar {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 15px;
    }
    #balance {
      font-size: 18px;
      margin-bottom: 5px;
    }
    #progressWrap {
      width: 200px;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      height: 12px;
      margin-bottom: 10px;
    }
    #progress {
      background: linear-gradient(90deg, #00c896, #00a3ff);
      height: 100%;
      width: 0%;
      transition: width 1s linear;
    }
    #controls {
      margin-bottom: 10px;
    }
    select, input[type="number"] {
      padding: 5px;
      font-size: 14px;
      margin-right: 5px;
    }
    button {
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      margin-left: 5px;
      border: none;
      border-radius: 6px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    #game {
      display: grid;
      gap: 2px;
    }
    .cell {
      width: 40px;
      height: 40px;
      background-color: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      user-select: none;
      transition: background-color 0.2s, transform 0.1s ease;
    }
    .cell:hover {
      background-color: rgba(255,255,255,0.12);
      transform: scale(1.05);
    }
    .cell.open {
      background-color: #ccc;
      color: black;
      cursor: default;
    }
    .cell.mine {
      background-color: red;
    }
    .cell.flag {
      background-color: #888;
      color: yellow;
    }
    #shop {
      margin-top: 15px;
      border: 1px solid #555;
      padding: 10px;
      border-radius: 8px;
      width: 280px;
    }
    .shop-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }
    #stats {
      margin-top: 15px;
    }
    #confettiCanvas {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
  
    #adminPanel {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      z-index: 9999;
      color: white;
      min-width: 300px;
    }
    #adminPanel input {
      width: 100%;
      padding: 6px;
      margin: 5px 0;
    }
    #adminPanel button {
      width: 100%;
      margin-top: 5px;
    }


    /* –¢—Ä–∏–ø–ª–µ—Ç: –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ —Ç—Ä—ë—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ü–∏—Ñ—Ä–∞—Ö */
    .cell.triplet {
      box-shadow: 0 0 12px 4px rgba(255,215,0,0.85);
      transform: scale(1.06);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

</style>
</head>
<body>

<h1>–°–∞–ø—ë—Ä üí£</h1>
<div id="topBar">
  <div id="balance"></div>
  <div id="progressWrap"><div id="progress"></div></div>
  <small>+500 –º–æ–Ω–µ—Ç –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç</small>
</div>

<div id="controls">
  <select id="boardSize">
    <option value="8,8,10">8√ó8 ‚Äî 10 –º–∏–Ω</option>
    <option value="12,12,25">12√ó12 ‚Äî 25 –º–∏–Ω (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ)</option>
  </select>
  <input type="number" id="bet" placeholder="–°—Ç–∞–≤–∫–∞" min="1">
  <button id="startGame">üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
  <button id="hintBtn">–ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
  <button id="autoFlagBtn">–ê–≤—Ç–æ—Ñ–ª–∞–≥</button>
  <button id="autoClearBtn">–†–∞–∑–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
</div>

<div id="game"></div>

<div id="shop">
  <h3>–ú–∞–≥–∞–∑–∏–Ω –±–æ–Ω—É—Å–æ–≤</h3>
  <div class="shop-item"><span>–ü–æ–¥—Å–∫–∞–∑–∫–∞ (150)</span><button data-item="hint" data-cost="150">–ö—É–ø–∏—Ç—å</button></div>
  <div class="shop-item"><span>–ê–≤—Ç–æ—Ñ–ª–∞–≥ (350)</span><button data-item="autoFlag" data-cost="350">–ö—É–ø–∏—Ç—å</button></div>
  <div class="shop-item"><span>–†–∞–∑–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (800)</span><button data-item="autoClear" data-cost="800">–ö—É–ø–∏—Ç—å</button></div>
</div>

<div id="stats">
  <p>–£—Ä–æ–≤–µ–Ω—å: <span id="level">1</span> | XP: <span id="xp">0</span></p>
  <p>–†–µ–∫–æ—Ä–¥—ã: <span id="records">‚Äî</span></p>
</div>

<canvas id="confettiCanvas"></canvas>

<script>
// --- Game Variables ---
let rows = 8, cols = 8, mineCount = 10;
let countsOpened = {};
let specialTripletTriggered = false;
let field = [];
let gameOver = true;
let balance = 0;
let currentBet = 0;
let coinsTimer = 0;
let level = 1;
let xp = 0;
let records = JSON.parse(localStorage.getItem("records") || "[]");
let bonuses = { hint: 0, autoFlag: 0, autoClear: 0 };

const gameContainer = document.getElementById("game");
const balanceEl = document.getElementById("balance");
const progressEl = document.getElementById("progress");
const betInput = document.getElementById("bet");
const startGameBtn = document.getElementById("startGame");
const boardSizeSelect = document.getElementById("boardSize");
const xpEl = document.getElementById("xp");
const levelEl = document.getElementById("level");
const recordsEl = document.getElementById("records");

function loadState() {
  balance = parseInt(localStorage.getItem("balance") || "1000", 10);
  xp = parseInt(localStorage.getItem("xp") || "0", 10);
  level = parseInt(localStorage.getItem("level") || "1", 10);
  bonuses = JSON.parse(localStorage.getItem("bonuses") || '{"hint":0,"autoFlag":0,"autoClear":0}');
  updateUI();
}
function saveState() {
  localStorage.setItem("balance", balance);
  localStorage.setItem("xp", xp);
  localStorage.setItem("level", level);
  localStorage.setItem("bonuses", JSON.stringify(bonuses));
  localStorage.setItem("records", JSON.stringify(records));
}

function updateUI() {
  balanceEl.textContent = `–ú–æ–Ω–µ—Ç—ã: ${balance}`;
  xpEl.textContent = xp;
  levelEl.textContent = level;
  recordsEl.textContent = records.join(", ") || "‚Äî";
}

function checkBankrupt() {
  if (balance <= 0) {
    balance = 100;
    alert("üí∞ –í—ã –±–∞–Ω–∫—Ä–æ—Ç! –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ 100 –º–æ–Ω–µ—Ç –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–≥—Ä—ã.");
    saveState();
    updateUI();
  }
}
function addCoinsOverTime() {
  setInterval(() => {
    coinsTimer += 1;
    let progress = (coinsTimer / (30*60)) * 100;
    progressEl.style.width = progress + "%";
    if (coinsTimer >= 30*60) {
      coinsTimer = 0;
      balance += 500;
      saveState();
      updateUI();
    }
  }, 1000);
}

function createField() {
  gameContainer.innerHTML = "";
  gameContainer.style.gridTemplateColumns = `repeat(${cols}, 40px)`;
  field = [];
  gameOver = false;
  countsOpened = {};
  specialTripletTriggered = false;
  for (let r=0; r<rows; r++) {
    field[r] = [];
    for (let c=0; c<cols; c++) {
      field[r][c] = {mine:false, open:false, flagged:false, count:0, element:null};
    }
  }
  let placed = 0;
  while (placed < mineCount) {
    let rr = Math.floor(Math.random()*rows);
    let cc = Math.floor(Math.random()*cols);
    if (!field[rr][cc].mine) {field[rr][cc].mine = true; placed++;}
  }
  for (let r=0; r<rows; r++) {
    for (let c=0; c<cols; c++) {
      if (field[r][c].mine) continue;
      let count = 0;
      for (let dr=-1; dr<=1; dr++) for (let dc=-1; dc<=1; dc++) {
        let nr = r+dr, nc = c+dc;
        if (nr>=0 && nr<rows && nc>=0 && nc<cols && field[nr][nc].mine) count++;
      }
      field[r][c].count = count;
    }
  }
  for (let r=0; r<rows; r++) {
    for (let c=0; c<cols; c++) {
      let cell = document.createElement("div");
      cell.classList.add("cell");
      cell.dataset.r = r; cell.dataset.c = c;
      cell.onclick = () => onLeftClick(r,c);
      cell.oncontextmenu = (e) => {e.preventDefault(); toggleFlag(r,c);};
      gameContainer.appendChild(cell);
      field[r][c].element = cell;
    }
  }
}

function onLeftClick(r,c) {
  if (gameOver) return;
  let cell = field[r][c];
  if (cell.open || cell.flagged) return;
  if (cell.mine) {
    revealAllMines();
    gameOver = true;
    balance -= currentBet;
    saveState();
    checkBankrupt();
    updateUI();
    alert("üí• –ü–æ—Ä–∞–∂–µ–Ω–∏–µ!");
    return;
  }
  openCell(r,c);
  if (checkWin()) {
    gameOver = true;
    balance += currentBet*2;
    xp += 50;
    if (xp >= 100) {level++; xp=0;}
    records.push(`${rows}x${cols}:${mineCount}`);
    saveState();
    updateUI();
    alert("üéâ –ü–æ–±–µ–¥–∞!");
  }
}

function toggleFlag(r,c) {
  let cell = field[r][c];
  if (cell.open) return;
  cell.flagged = !cell.flagged;
  cell.element.classList.toggle("flag");
  cell.element.textContent = cell.flagged ? "üö©" : "";
}

function openCell(r,c) {
  let cell = field[r][c];
  if (cell.open || cell.flagged) return;
  cell.open = true;
  cell.element.classList.add("open");
  if (cell.count>0) {
    cell.element.textContent = cell.count;
    // --- Track triplets of identical numbers ---
    if (typeof countsOpened === 'undefined') countsOpened = {};
    if (typeof specialTripletTriggered === 'undefined') specialTripletTriggered = false;
    if (cell.count > 0) {
      countsOpened[cell.count] = (countsOpened[cell.count] || 0) + 1;
      // –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ —Ç—Ä—ë—Ö –∏ –µ—â—ë –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ ‚Äî –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–∞–µ–º –∏–≥—Ä–æ–∫–∞
      if (!specialTripletTriggered && countsOpened[cell.count] >= 3 && currentBet > 0) {
        specialTripletTriggered = true;
        // –ø–æ–¥—Å–≤–µ—Ç–∏–º –ø–µ—Ä–≤—ã–µ —Ç—Ä–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–ª–µ—Ç–∫–∏
        highlightTriplet(cell.count);
        // –º–Ω–æ–∂–∏—Ç–µ–ª—å: –º–∏–Ω–∏–º—É–º 2x, –±–æ–ª—å—à–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª (—Ä–µ–∂–µ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è)
        const multiplier = Math.max(2, 1 + cell.count * 0.5);
        const award = Math.round(currentBet * multiplier);
        balance += award;
        saveState();
        updateUI();
        setTimeout(()=> alert(`üéâ –ù–∞–π–¥–µ–Ω—ã 3 —Ü–∏—Ñ—Ä—ã "${cell.count}" ‚Äî –≤—ã –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç–µ ${award} –º–æ–Ω–µ—Ç! (–º–Ω–æ–∂–∏—Ç–µ–ª—å ${multiplier}x)`), 80);
        gameOver = true;
      }
    }

  } else {
    for (let dr=-1; dr<=1; dr++) for (let dc=-1; dc<=1; dc++) {
      let nr = r+dr, nc = c+dc;
      if (nr>=0 && nr<rows && nc>=0 && nc<cols) openCell(nr,nc);
    }
  }
}

function revealAllMines() {
  for (let r=0; r<rows; r++) for (let c=0; c<cols; c++) {
    if (field[r][c].mine) {
      field[r][c].element.classList.add("mine");
      field[r][c].element.textContent = "üí£";
    }
  }
}


function highlightTriplet(targetCount){
  let found = 0;
  for (let r=0; r<rows && found<3; r++){
    for (let c=0; c<cols && found<3; c++){
      if (field[r][c].open && field[r][c].count === targetCount) {
        field[r][c].element.classList.add('triplet');
        found++;
      }
    }
  }
}

function checkWin() {
  for (let r=0; r<rows; r++) for (let c=0; c<cols; c++) {
    if (!field[r][c].mine && !field[r][c].open) return false;
  }
  return true;
}

document.querySelectorAll("#shop button").forEach(btn=>{
  btn.onclick = () => {
    let cost = parseInt(btn.dataset.cost,10);
    let item = btn.dataset.item;
    if (balance >= cost) {
      balance -= cost;
      bonuses[item]++;
      saveState();
      updateUI();
      alert(`–ö—É–ø–ª–µ–Ω –±–æ–Ω—É—Å: ${item}`);
    } else {
      alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!");
    }
  };
});

startGameBtn.onclick = () => {
  let bet = parseInt(betInput.value,10);
  if (isNaN(bet) || bet<=0 || bet>balance) {
    alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞!");
    return;
  }
  currentBet = bet;
  [rows,cols,mineCount] = boardSizeSelect.value.split(",").map(Number);
  createField();
};

loadState();
addCoinsOverTime();

// --- Admin Panel Logic ---
function adminAddCoins() {
  const val = parseInt(document.getElementById('adminCoins').value,10);
  if (!isNaN(val)) {
    balance += val;
    saveState();
    updateUI();
    alert('–ú–æ–Ω–µ—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã.');
  }
}
function adminResetProgress() {
  if (confirm('–¢–æ—á–Ω–æ –æ–±–Ω—É–ª–∏—Ç—å?')) {
    balance = 1000; xp = 0; level = 1; records = []; bonuses = {hint:0, autoFlag:0, autoClear:0};
    saveState();
    updateUI();
    alert('–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω—É–ª—ë–Ω.');
  }
}
function adminGiveBonuses() {
  bonuses.hint += 5;
  bonuses.autoFlag += 5;
  bonuses.autoClear += 5;
  saveState();
  updateUI();
  alert('–í—ã–¥–∞–Ω–æ –ø–æ 5 –∫–∞–∂–¥–æ–≥–æ –±–æ–Ω—É—Å–∞.');
}
function adminLevelUp() {
  level++;
  saveState();
  updateUI();
  alert('–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω.');
}
// Toggle with Ctrl+Shift+A
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.shiftKey && e.code === 'KeyA') {
    const panel = document.getElementById('adminPanel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
  }
});

</script>


<div id="adminPanel">
  <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
  <label>–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã:</label>
  <input type="number" id="adminCoins" placeholder="–ö–æ–ª-–≤–æ">
  <button onclick="adminAddCoins()">–î–æ–±–∞–≤–∏—Ç—å</button>
  <button onclick="adminResetProgress()">–û–±–Ω—É–ª–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
  <button onclick="adminGiveBonuses()">–í—ã–¥–∞—Ç—å –±–æ–Ω—É—Å—ã</button>
  <button onclick="adminLevelUp()">–ü–æ–≤—ã—Å–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
  <button onclick="document.getElementById('adminPanel').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

</body>
</html>